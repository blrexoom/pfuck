<html>
<head>
    <meta charset="utf-8" />
    <meta name="renderer" content="webkit" />
    <meta name="viewport" content="width=device-width" />
    <meta name="viewport" content="initial-scale=1.0,user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta content="black" name="apple-mobile-web-app-status-bar-style" />
    <meta name="theme-color" content="#FFFFFF" />
    <title>{{htmlTitle}}}</title>
    <link rel="stylesheet" href="/static/css/foundation.min.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="/static/css/style.css" type="text/css" media="screen" />
    <script src="/static/js/jquery-1.12.0.min.js"></script>
    <script src="/static/js/foundation.min.js"></script>
    <script src="/static/js/ycom.js"></script>
</head>
<body class="{{appName}}">
<script>
    appName = '{{appName}}';
</script>
<div class="main">
    <div class="box config">
        <h3>{{htmlTitle}}</h3>
        <form id="config-form" accept-charset="GBK">
            <label>短信文件路径：<input type="text" name="smsFile" checked value="{{configsSmsFile}}" /></label>

            <button class="button">保存</button>
        </form>
    </div>
    <div class="box operate">
        <form id="func-form">
            <label><input type="checkbox" name="fetchVcode" checked />需要获取验证码</label>
        </form>
        <textarea class="auto-height" name="links" id="links" rows="1" placeholder="红包链接队列，多个分行"></textarea>
        <input type="number" name="phone" id="phone" placeholder="电话号码" />
        <button class="button" data-run="false" id="run-all">开始</button>
    </div>
    <div id="logs"></div>
</div>

<div id="log-tpl" style="display: none">
    <div id="log-wrapper_{id}" class="box log-wrapper">
        <div class="log-info">
            <span class="log-id">#{id}</span>
            <span class="log-title">{phoneNum}</span>
            <div class="log-operate">
                <button data-id="{id}" data-phone="{phoneNum}" data-run="false" class="button run">开始</button>
            </div>
        </div>
        <form class="input-form" data-id="{id}">
            <input type="hidden" name="id", value="{id}" />
            <input type="hidden" name="app", value="{{appName}}" />
            <input type="hidden" name="key", value="vcode" />
            <input type="text" name="value" placeholder="输入内容" />
            <button class="button">提交</button>
        </form>
        <div data-offset="-1" data-id="{id}" id="log_{id}" class="log"></div>
    </div>
</div>

<script>
logTimer = 0;
logQuery = {};

getLog = function() {
    logTimer = setInterval(function(){
        $('#logs .log').each(function(index, el) {
            logQuery[$(this).data('id')] = $(this).data('offset');
        });

        $.ajax({
            url: '/log',
            type: 'get',
            dataType: 'json',
            timeout: 1000,
            data: {query: JSON.stringify(logQuery)}
        })
        .done(function(result) {
            for (var x in result) {
                var html = '';
                var logBox = $('#log_' + x);

                if (logBox.length > 0) {
                    for (var i in result[x]['logs']) {
                        html += '<p>'+ Ycom.htmlEncode(result[x]['logs'][i]) +'</p>';
                    }

                    logBox.data('offset', result[x]['offset'] + result[x]['logs'].length);
                    logBox.append(html);
                    logBox.scrollTop(logBox[0].scrollHeight);
                }
            }
        })
        .fail(function() {
        })
        .always(function() {
        });
    }, 1000);
}

startAll = function() {
    runButtons = $('#logs .run');
    for (var i = 0; i < runButtons.length; ++i) {
        setTimeout((function(i) {
            return function() {
                var button = runButtons.get(i);
                if (!$(button).data('run')) {
                    runButtons.get(i).click();
                }
            };
        })(i), i * 100);
    }

    clearInterval(logTimer);
    getLog();
}

stopAll = function() {
    runButtons = $('#logs .run');
    for (var i = 0; i < runButtons.length; ++i) {
        setTimeout((function(i) {
            return function() {
                var button = runButtons.get(i);
                if ($(button).data('run')) {
                    button.click();
                }
            };
        })(i), i * 100);
    }

    // clearInterval(logTimer);
}

startOne = function(id, phoneNum, links) {
    data = $('#func-form').serializeJson();
    data.id = id;
    data.phoneNum = phoneNum;
    data.links = links

    $.ajax({
        url: '/' + appName + '/startRedBag',
        type: 'post',
        dataType: 'json',
        timeout: 500000,
        data: data,
    })
    .done(function(result) {
        if (result.status == 'ok') {
            console.log(result.id)
            $('.run[data-id='+ result.id +']').click();
        }
    })
    .fail(function() {
        console.log('执行有误');
    })
    .always(function() {
    });


    $('#run-all').data('run', true);
    $('#run-all').text('停止');
}

communicate = function(id, key, value) {
    $.ajax({
        url: '/communicate',
        type: 'post',
        dataType: 'json',
        timeout: 1000,
        data: {app: appName, id: id, key: key, value: value},
    })
    .done(function(result) {
    })
    .fail(function() {
        alert('网络错误');
    })
    .always(function() {
    });
}

stopOne = function(id) {
    communicate(id, 'run', 'false');

    var runOne = false;
    var runButtons = $('#logs .run');

    for (var i = 0; i < runButtons.length; ++i) {
        runOne = $(runButtons.get(i)).data('run');
        if (runOne) {
            break;
        }
    }

    if (!runOne) {
        $('#run-all').data('run', false);
        $('#run-all').text('开始');
        // clearInterval(logTimer);
    }
}

$(function(){
    logBoxTpl = $('#log-tpl').html();

    $('.auto-height').bind('input propertychange change', function(e){
          $(this).height(0);
          $(this).outerHeight($(this)[0].scrollHeight+2);
    });

    $('#run-all').click(function(event) {
        if ($(this).data('run')) {
            stopAll();
        } else {
            var phoneNums = $.trim($('#phone').val()).split('\n');

            html = '';
            for (var i = 0; i < phoneNums.length; ++i) {
                if ($.trim(phoneNums[i])) {
                    html += Ycom.formatStr(logBoxTpl, {
                        id: i + 100,
                        phoneNum: phoneNums[i],
                    });
                }
            }

            $('#logs').html(html);
            startAll();
        }
    });

    $(document).on('click', '.run', function(event) {
        if ($(this).data('run')) {
            $(this).data('run', false);
            $(this).text('开始');

            stopOne($(this).data('id'));
        } else {
            $(this).data('run', true);
            $(this).text('停止');

            startOne($(this).data('id'), $(this).data('phone'), $('#links').val());
        }
    });

    $(document).on('submit', '.input-form', function(event) {
        $.ajax({
            url: '/communicate',
            type: 'post',
            dataType: 'json',
            timeout: 1000,
            data: $(this).serialize()
        })
        .done(function(result) {
        })
        .fail(function() {
            alert('网络错误');
        })
        .always(function() {
        });

        return false;
    });

    $('#config-form').submit(function(event) {
        $.ajax({
            url: '/saveConfig',
            type: 'post',
            dataType: 'json',
            timeout: 1000,
            data: $(this).serialize()
        })
        .done(function(result) {
            alert(result.info)
        })
        .fail(function() {
            alert('网络错误');
        })
        .always(function() {
        });

        return false;
    });
});

</script>
</body>
</html>
